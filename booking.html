<!DOCTYPE html>
<html>
  <head>
    <title>Book Seats!</title>
    <link rel="stylesheet" href="booking.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-firestore.js"></script>
    <script src="fbinit.js"></script>
  </head>
  <body>
    <div id="notlog">
      <div class="theatre">
        <div class="cinema-seats left">
          <div class="cinema-row row-1" style="margin-top: -10%;">
            <h1 class="rows"></h1>
            <div class="columns">A</div>
            <div class="columns">B</div>
            <div class="columns">C</div>
            <div class="columns">D</div>
            <div class="columns">E</div>
            <div class="columns">F</div>
            <div class="columns">G</div>
          </div>
          <div class="cinema-row row-1">
            <h1 class="row">1</h1>

            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-2">
            <h1 class="row">2</h1>

            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-3">
            <h1 class="row">3</h1>

            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-4">
            <h1 class="row">4</h1>

            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-5">
            <h1 class="row">5</h1>

            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-6">
            <h1 class="row">6</h1>

            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-7">
            <h1 class="row">7</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>
        </div>

        <div class="cinema-seats right">
          <div class="cinema-row row-1">
            <h1 class="row">8</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-2">
            <h1 class="row">9</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-3">
            <h1 class="row1">10</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-4">
            <h1 class="row1">11</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-5">
            <h1 class="row1">12</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-6">
            <h1 class="row1">13</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>

          <div class="cinema-row row-7">
            <h1 class="row1">14</h1>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
            <div class="seat"></div>
          </div>
        </div>
      </div>
      <div>
        <h1 class="booked"></h1>
        <h1 class="seatsbooked"></h1>
        <h1 class="hochuki"></h1>
        <button class="btn" onclick="showDialog()">Book</button>
      </div>
    </div>
    <div id="log">
      <p style="color: whitesmoke;">Pls login</p>
    </div>
    <div id="thanku">
      <p style="color: whitesmoke;">Thx :p</p>
    </div>

    <!-- Seat Selection -->
    <script type="text/javascript">
      Array.prototype.remove = function () {
        var what,
          a = arguments,
          L = a.length,
          ax;
        while (L && this.length) {
          what = a[--L];
          while ((ax = this.indexOf(what)) !== -1) {
            this.splice(ax, 1);
          }
        }
        return this;
      };
      let seatnametemp = "";
      $(".cinema-seats .seat").on("click", function () {
        seatnametemp = "";
        $(this).toggleClass("active"); // yaha if statement
        let active = $(".seat.active");
        active.each(function () {
          let seatsPerRow = $(this).parent().find(".seat").length;
          if (!$(this).closest(".cinema-seats").hasClass("right")) {
            let prevRows =
              $(this).parent(".cinema-row").prevAll(".cinema-row").length - 1;
            seatnametemp +=
              (prevRows + 1).toString() +
              ($(this).index() + 9).toString(36).toUpperCase() +
              " ";
          } else {
            let leftSeats = $(".left").find(".seat").length;
            let prevRows = $(this).parent(".cinema-row").prevAll(".cinema-row")
              .length;
            seatnametemp +=
              (prevRows + 8).toString() +
              ($(this).index() + 9).toString(36).toUpperCase() +
              " ";
          }
        });
        var bookedSeats = document.querySelectorAll(".active").length;
        document.querySelector(".booked").innerHTML = bookedSeats + " Booked";
        document.querySelector(".seatsbooked").innerHTML = seatnametemp;
      });
    </script>
    <!-- Seat Selection end  -->
    <!-- Verification and Adding Booked seats to firebase -->
    <script>
      var currr = localStorage.getItem("currentuser");
      var bookHogayi = "";
      var kisneki = "";
      var cloned = "";
      window.onload = function checkuser() {
        if (currr === "") {
          $("#notlog").remove();
          $("#thanku").hide();
        } else {
          $("#log").remove();
          $("#thanku").hide();
          var docRef = db.collection("users").doc(currr);
          docRef.get().then(function (doc) {
            console.log("Document data:", doc.data());
          });
          db.collection("seats")
            .get()
            .then(function (querySnapshot) {
              querySnapshot.forEach(function (doc) {
                // doc.data() is never undefined for query doc snapshots
                bookHogayi += doc.id + " ";
                kisneki += doc.get("seatOwner") + " ";
              });
              document.querySelector(".hochuki").innerHTML = bookHogayi;
              dekhle(bookHogayi, kisneki);
            });
        }
      };
      window.onunload = function checkuser() {
        localStorage.setItem("currentuser", "");
      };
      function showDialog() {
        finalSeats = document.querySelector(".seatsbooked").innerHTML;
        ready = confirm(
          "Are you sure you want to book the following seats for â‚¹" +
            " 200 : \n" +
            finalSeats
        );
        if (ready === true) {
          for (i = 0; i < finalSeats.trim().split(" ").length; i++) {
            db.collection("seats")
              .doc(finalSeats.trim().split(" ")[i])
              .set({
                seatNumber: finalSeats.trim().split(" ")[i],
                seatOwner: currr,
              });
          }
          $("#notlog").remove();
          $("#thanku").show();
        } else {
          console.log("lolgareeb");
        }
      }
    </script>
    <!-- Verification and Adding Booked seats to firebase end -->
    <!-- Disable seats that are already booked -->
    <script>
      window.onbeforeunload = function (e) {
        return "Don't leave";
      };
      function dekhle(allBooked, bande) {
        var eachSeat = allBooked.toString().split(" ");
        eachSeat.remove("");
        var eachOwner = bande.split(" ");
        for (i = 0; i < eachSeat.length; i++) {
          var number = 0;
          var numberfromString = 0;

          var str = eachSeat[i];
          var matches = str.match(/(\d+)/);

          number = matches[0];
          var letter = eachSeat[i].replace(/[0-9]/g, "").toString();
          numberfromString = letter.toLowerCase().charCodeAt(0) - 97 + 1;
          owner = eachOwner[i];
          getSeat(number, numberfromString, owner);
        }
      }
      function getSeat(num, letr, prsn) {
        letr += 1;
        if (num <= 7) {
          var selector =
            ".left .row-" +
            num.toString() +
            " .seat:nth-child(" +
            letr.toString() +
            ")";
          if (currr === prsn) {
            $(selector).addClass("same");
          } else {
            $(selector).addClass("different");
          }
        } else if (num > 7) {
          num -= 7;
          var selector =
            ".right .row-" +
            num.toString() +
            " .seat:nth-child(" +
            letr.toString() +
            ")";
          if (currr === prsn) {
            $(selector).addClass("same");
          } else {
            $(selector).addClass("different");
          }
        } else if (num >= 10) {
        }
      }
    </script>
    <!-- Disable seats that are already booked end -->
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-firestore.js"></script>
  </body>
</html>
